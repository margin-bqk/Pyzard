# Pyzard 冲突处理功能说明

## 功能概述

本次更新为 Pyzard 文件管理工具添加了完整的冲突处理系统，支持四种冲突处理模式：跳过、覆盖、创建副本、合并（仅文件夹）。

## 冲突处理模式

### 1. 跳过模式 (skip)
- **描述**: 遇到同名文件/文件夹时跳过操作
- **适用场景**: 避免数据丢失，保持现有文件不变
- **撤回行为**: 无影响，因为未创建新文件

### 2. 覆盖模式 (overwrite)
- **描述**: 用源文件覆盖目标文件
- **适用场景**: 需要更新文件内容
- **撤回行为**: 删除目标文件，恢复备份（剪切模式）

### 3. 副本模式 (copy)
- **描述**: 为冲突文件创建带编号的副本
- **适用场景**: 保留所有版本，避免数据丢失
- **撤回行为**: 删除副本文件

### 4. 合并模式 (merge) - 仅文件夹
- **描述**: 合并源文件夹和目标文件夹的内容
- **适用场景**: 需要整合两个文件夹的内容
- **撤回行为**: 删除新增的文件/文件夹

## 实现架构

### 核心工具函数

#### `resolve_conflict(source_path, target_path, conflict_mode, is_folder=False)`
统一的冲突解决方案，返回处理后的目标路径或None（表示跳过）。

#### `generate_copy_name(original_path)`
生成带编号的副本名称，如 `原文件名_副本1.扩展名`。

#### `merge_folders(source_folder, target_folder)`
递归合并两个文件夹的内容。

### 修改的操作函数

所有主要操作函数都已更新支持冲突处理模式：

- `search_and_copy_files()` - 搜索并复制文件
- `extract_entire_folder()` - 提取整个文件夹
- `rename_files_in_place()` - 原地重命名文件
- `copy_files_from_csv_paths()` - 从CSV路径复制文件

### 用户界面

新增 `select_conflict_mode()` 函数，在每次操作前让用户选择冲突处理模式。

## 撤回功能增强

撤回功能已更新以支持不同的冲突处理模式：

- **副本模式**: 正确删除创建的副本文件
- **覆盖模式**: 正确处理文件覆盖的撤回
- **合并模式**: 正确处理文件夹合并的撤回

## 测试验证

已创建完整的测试套件验证所有功能：

1. **test_conflict_modes.py** - 测试四种冲突处理模式
2. **test_undo_function.py** - 测试撤回功能
3. **test_error_handling.py** - 测试错误处理

所有测试均通过，证明功能稳定可靠。

## 使用示例

### 基本使用流程

1. 运行程序：`python Pyzard.py`
2. 选择功能（1-6）
3. 选择冲突处理模式：
   ```
   请选择冲突处理模式:
     skip: 跳过冲突文件
     overwrite: 覆盖现有文件
     copy: 创建副本
     merge: 合并文件夹内容
   ```
4. 输入路径参数
5. 执行操作

### 冲突处理示例

**场景**: 复制文件时遇到同名文件

- **skip模式**: 跳过该文件，继续处理其他文件
- **overwrite模式**: 覆盖目标文件
- **copy模式**: 创建 `原文件名_副本1.txt`
- **merge模式**: 仅适用于文件夹，合并内容

## 技术特点

1. **统一架构**: 所有操作使用相同的冲突处理逻辑
2. **数据安全**: 默认使用副本模式避免数据丢失
3. **用户友好**: 清晰的提示信息和选择界面
4. **完整撤回**: 支持所有冲突模式的撤回操作
5. **错误处理**: 完善的异常处理和错误提示

## 默认设置

- **默认冲突模式**: `copy`（创建副本）
- **历史记录**: 自动保存操作历史
- **备份清理**: 智能清理旧备份文件

这个冲突处理系统显著提高了程序的数据安全性和用户体验，解决了原始问题中提到的错误处理不健全的问题。
